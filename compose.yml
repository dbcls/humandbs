services:
  cms-db:
    image: docker.io/postgres:17
    container_name: ${CONTAINER_PREFIX}-cms-db
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - cms-pgdata:/var/lib/postgresql/data
    ports:
      - ${DB_BIND_HOST}:5432:5432
    networks:
      - humandbs-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      retries: 5
      start_period: 30s
      timeout: 10s
    init: true

  cms-db-migrator:
    build:
      context: .
      dockerfile: Dockerfile
    image: ${CONTAINER_PREFIX}-app
    container_name: ${CONTAINER_PREFIX}-cms-db-migrator
    depends_on:
      cms-db:
        condition: service_healthy
    environment:
      - POSTGRES_HOST=cms-db
      - POSTGRES_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - ${PWD}:/app
    working_dir: /app
    networks:
      - humandbs-network
    entrypoint: ["sleep", "infinity"]
    init: true

  frontend:
    build:
      context: .
      dockerfile: Dockerfile
    image: ${CONTAINER_PREFIX}-app
    container_name: ${CONTAINER_PREFIX}-frontend
    depends_on:
      - cms-db
      - backend
    environment:
      - HUMANDBS_FRONTEND_HOST=0.0.0.0
      - HUMANDBS_FRONTEND_PORT=3000
      - POSTGRES_HOST=cms-db
      - POSTGRES_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - HUMANDBS_BACKEND_HOST=backend
      - HUMANDBS_BACKEND_PORT=8080
      - OIDC_ISSUER_URL=${OIDC_ISSUER_URL}
      - OIDC_CLIENT_ID=${OIDC_CLIENT_ID}
      - OIDC_REDIRECT_URI=${OIDC_REDIRECT_URI}
    volumes:
      - ${PWD}:/app
      - node_modules:/app/node_modules
      - frontend_node_modules:/app/apps/frontend/node_modules
      - backend_node_modules:/app/apps/backend/node_modules
      - eslint_config_node_modules:/app/packages/eslint-config/node_modules
    working_dir: /app
    ports:
      - ${FRONTEND_BIND_HOST}:3000:3000
    networks:
      - humandbs-network
    command: ["sleep", "infinity"]
    init: true

  backend:
    build:
      context: .
      dockerfile: Dockerfile
    image: ${CONTAINER_PREFIX}-app
    container_name: ${CONTAINER_PREFIX}-backend
    environment:
      - HUMANDBS_BACKEND_HOST=0.0.0.0
      - HUMANDBS_BACKEND_PORT=8080
    volumes:
      - ${PWD}:/app
      - node_modules:/app/node_modules
      - frontend_node_modules:/app/apps/frontend/node_modules
      - backend_node_modules:/app/apps/backend/node_modules
      - eslint_config_node_modules:/app/packages/eslint-config/node_modules
    working_dir: /app
    networks:
      - humandbs-network
    command: ["sleep", "infinity"]
    init: true

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.17.6
    container_name: ${CONTAINER_PREFIX}-elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - bootstrap.memory_lock=true
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
    volumes:
      - es-data:/usr/share/elasticsearch/data
    networks:
      - humandbs-network
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
      memlock:
        soft: -1
        hard: -1
    mem_limit: ${ES_MEM_LIMIT}
    init: true

  nginx:
    image: docker.io/library/nginx:1.27.0
    container_name: ${CONTAINER_PREFIX}-nginx
    volumes:
      - ${PWD}/nginx.conf:/etc/nginx/conf.d/default.conf
    ports:
      - ${FRONTEND_BIND_HOST}:${NGINX_PORT}:80
    networks:
      - humandbs-network
    init: true

volumes:
  node_modules: {}
  frontend_node_modules: {}
  backend_node_modules: {}
  eslint_config_node_modules: {}
  cms-pgdata: {}
  es-data: {}

networks:
  humandbs-network:
    name: ${NETWORK_NAME}
    external: true
