services:
  cms-db:
    image: docker.io/postgres:17
    container_name: ${HUMANDBS_CONTAINER_PREFIX}-cms-db
    environment:
      - TZ=${HUMANDBS_TZ}
      - POSTGRES_USER=${HUMANDBS_POSTGRES_USER}
      - POSTGRES_PASSWORD=${HUMANDBS_POSTGRES_PASSWORD:?HUMANDBS_POSTGRES_PASSWORD is required}
      - POSTGRES_DB=${HUMANDBS_POSTGRES_DB}
    volumes:
      - cms-pgdata:/var/lib/postgresql/data
    networks:
      - humandbs-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${HUMANDBS_POSTGRES_USER} -d ${HUMANDBS_POSTGRES_DB}" ]
      interval: 10s
      retries: 5
      start_period: 30s
      timeout: 10s
    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "10"
    init: true

  frontend:
    build:
      context: .
      dockerfile: Dockerfile
    image: ${HUMANDBS_CONTAINER_PREFIX}-app
    container_name: ${HUMANDBS_CONTAINER_PREFIX}-frontend
    depends_on:
      cms-db:
        condition: service_healthy
      backend:
        condition: service_started
    environment:
      - TZ=${HUMANDBS_TZ}
      - NODE_ENV=${HUMANDBS_NODE_ENV}
      # Container network (fixed)
      - HUMANDBS_POSTGRES_HOST=cms-db
      - HUMANDBS_POSTGRES_PORT=5432
      - HUMANDBS_BACKEND_HOST=backend
      - HUMANDBS_BACKEND_PORT=8080
      # Server binding (fixed)
      - HUMANDBS_FRONTEND_HOST=0.0.0.0
      - HUMANDBS_FRONTEND_PORT=3000
      # Credentials (from .env)
      - HUMANDBS_POSTGRES_USER=${HUMANDBS_POSTGRES_USER}
      - HUMANDBS_POSTGRES_PASSWORD=${HUMANDBS_POSTGRES_PASSWORD:?HUMANDBS_POSTGRES_PASSWORD is required}
      - HUMANDBS_POSTGRES_DB=${HUMANDBS_POSTGRES_DB}
      # External access (from .env)
      - HUMANDBS_AUTH_ISSUER_URL=${HUMANDBS_AUTH_ISSUER_URL}
      - HUMANDBS_AUTH_CLIENT_ID=${HUMANDBS_AUTH_CLIENT_ID}
      - HUMANDBS_AUTH_REDIRECT_URI=${HUMANDBS_AUTH_REDIRECT_URI}
    volumes:
      - .:/app
      - node_modules:/app/node_modules
      - frontend_node_modules:/app/apps/frontend/node_modules
      - backend_node_modules:/app/apps/backend/node_modules
      - eslint_config_node_modules:/app/packages/eslint-config/node_modules
    working_dir: /app/apps/frontend
    networks:
      - humandbs-network
    command: ${HUMANDBS_FRONTEND_COMMAND}
    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "10"
    init: true

  backend:
    build:
      context: .
      dockerfile: Dockerfile
    image: ${HUMANDBS_CONTAINER_PREFIX}-app
    container_name: ${HUMANDBS_CONTAINER_PREFIX}-backend
    depends_on:
      elasticsearch:
        condition: service_healthy
    environment:
      - TZ=${HUMANDBS_TZ}
      - NODE_ENV=${HUMANDBS_NODE_ENV}
      # Container network (fixed)
      - HUMANDBS_ES_HOST=elasticsearch
      - HUMANDBS_ES_PORT=9200
      # Server binding (fixed)
      - HUMANDBS_BACKEND_HOST=0.0.0.0
      - HUMANDBS_BACKEND_PORT=8080
      - HUMANDBS_BACKEND_URL_PREFIX=/api
      # External access (from .env)
      - HUMANDBS_AUTH_ISSUER_URL=${HUMANDBS_AUTH_ISSUER_URL}
      - HUMANDBS_AUTH_CLIENT_ID=${HUMANDBS_AUTH_CLIENT_ID}
    volumes:
      - .:/app
      - node_modules:/app/node_modules
      - frontend_node_modules:/app/apps/frontend/node_modules
      - backend_node_modules:/app/apps/backend/node_modules
      - eslint_config_node_modules:/app/packages/eslint-config/node_modules
    working_dir: /app/apps/backend
    networks:
      - humandbs-network
    command: ${HUMANDBS_BACKEND_COMMAND}
    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "10"
    init: true

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.17.6
    container_name: ${HUMANDBS_CONTAINER_PREFIX}-elasticsearch
    environment:
      - TZ=${HUMANDBS_TZ}
      - discovery.type=single-node
      - xpack.security.enabled=false
      - bootstrap.memory_lock=true
      - ES_JAVA_OPTS=${HUMANDBS_ES_JAVA_OPTS}
      - path.repo=/usr/share/elasticsearch/backup
    volumes:
      - es-data:/usr/share/elasticsearch/data
      - ${HUMANDBS_ES_BACKUP_PATH}:/usr/share/elasticsearch/backup
    networks:
      - humandbs-network
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
      memlock:
        soft: -1
        hard: -1
    mem_limit: ${HUMANDBS_ES_MEM_LIMIT}
    healthcheck:
      test: [ "CMD-SHELL", "curl -fsSL 'http://localhost:9200/_cluster/health?wait_for_status=yellow&timeout=5s'" ]
      interval: 5s
      retries: 12
      start_period: 10s
      timeout: 10s
    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "10"
    init: true

  nginx:
    image: docker.io/library/nginx:1.27.0
    container_name: ${HUMANDBS_CONTAINER_PREFIX}-nginx
    environment:
      - TZ=${HUMANDBS_TZ}
    depends_on:
      frontend:
        condition: service_started
      backend:
        condition: service_started
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
    ports:
      - ${HUMANDBS_NGINX_BIND_HOST}:${HUMANDBS_NGINX_PORT}:80
    networks:
      - humandbs-network
    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "10"
    init: true

volumes:
  node_modules: {}
  frontend_node_modules: {}
  backend_node_modules: {}
  eslint_config_node_modules: {}
  cms-pgdata: {}
  es-data: {}

networks:
  humandbs-network:
    name: ${HUMANDBS_NETWORK_NAME}
